# This is a basic workflow to help you get started with Actions

name: TestCI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: 
     
      - '*'         # matches every branch that doesn't contain a '/'
      - '*/*'       # matches every branch containing a single '/'
      - '**'        # matches every branch
      - '!dev'   # excludes dev
  
env:
 LOGIN: ${{ secrets.DOCKER_LOGIN }}
 NAME: ${{ secrets.DOCKER_NAME }}
 DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} 
 HOST: ${{ secrets.SERVER_IP }}
 USERNAME: ${{ secrets.SERVER_USERNAME }}
 PASSWORD: ${{ secrets.SERVER_PASSWORD }}
 #DEV_DB_USER_NAME: ${{ secrets.DEV_DB_USER_NAME }}
 #DEV_DB_NAME: ${{ secrets.DEV_DB_NAME }}
 #DEV_DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
 #DEV_DB_HOST: ${{ secrets.DEV_DB_HOST }}
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:


 
  build: 
    
    runs-on: ubuntu-latest
    steps:
      - name: Login to docker.io
        run:  echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin
      - uses: actions/checkout@master
      - name: Build image
        run: docker build -t $LOGIN/$NAME:last --build-arg DEV_DB_NAME=$DEV_DB_NAME --build-arg DEV_DB_USER_NAME=$DEV_DB_USER_NAME --build-arg DEV_DB_PASSWORD=$DEV_DB_PASSWORD  --build-arg DEV_DB_HOST=$DEV_DB_HOST -f Dockerfile .
      
      - name: Push image to docker.io
        run: docker push $LOGIN/$NAME:last
      
      
        
  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      
    - name: Push to server
      uses: appleboy/ssh-action@master
      with:
         host: $HOST
         username: $USERNAME
         password: $PASSWORD
         port: 22
         script: docker run 

    
      
        
    
